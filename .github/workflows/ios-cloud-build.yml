name: iOS Cloud Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:

jobs:
  build-test-screenshots:
    runs-on: macos-15
    timeout-minutes: 60
    env:
      APP_BUNDLE_ID: mzutv2
      DERIVED_DATA: DerivedData
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          set -euo pipefail

          SELECTED=""
          for app in $(ls -1d /Applications/Xcode*.app 2>/dev/null | sort -Vr); do
            dev="$app/Contents/Developer"
            if DEVELOPER_DIR="$dev" xcodebuild -showsdks 2>/dev/null | grep -q "iphonesimulator"; then
              SELECTED="$dev"
              break
            fi
          done

          if [ -z "$SELECTED" ]; then
            echo "No Xcode with iphonesimulator SDK detected. Trying to install iOS platform..."
            xcodebuild -downloadPlatform iOS || true
            if xcodebuild -showsdks | grep -q "iphonesimulator"; then
              SELECTED="$(xcode-select -p)"
            fi
          fi

          if [ -z "$SELECTED" ]; then
            echo "iphonesimulator SDK is still unavailable."
            xcodebuild -showsdks || true
            exit 1
          fi

          sudo xcode-select -s "$SELECTED"
          xcodebuild -version
          xcodebuild -showsdks

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Project
        run: xcodegen generate

      - name: Select Simulator
        run: |
          set -euo pipefail
          xcrun simctl shutdown all || true

          UDID="$(xcrun simctl list devices available | awk -F '[()]' '/iPhone 16 Pro/{print $2; exit}')"
          if [ -z "$UDID" ]; then
            UDID="$(xcrun simctl list devices available | awk -F '[()]' '/iPhone 16/{print $2; exit}')"
          fi
          if [ -z "$UDID" ]; then
            UDID="$(xcrun simctl list devices available | awk -F '[()]' '/iPhone 15 Pro/{print $2; exit}')"
          fi
          if [ -z "$UDID" ]; then
            UDID="$(xcrun simctl list devices available | awk -F '[()]' '/iPhone 15/{print $2; exit}')"
          fi

          if [ -z "$UDID" ]; then
            echo "No supported iPhone simulator available."
            exit 1
          fi

          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

          echo "SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"
          echo "Using simulator: $UDID"

      - name: Build
        run: |
          xcodebuild \
            -scheme mZUTiOSApp \
            -destination "platform=iOS Simulator,id=${SIMULATOR_UDID}" \
            -sdk iphonesimulator \
            -derivedDataPath "${DERIVED_DATA}" \
            build

      - name: Test
        run: |
          xcodebuild \
            -scheme mZUTiOSApp \
            -destination "platform=iOS Simulator,id=${SIMULATOR_UDID}" \
            -sdk iphonesimulator \
            -derivedDataPath "${DERIVED_DATA}" \
            test

      - name: Install App on Simulator
        run: |
          set -euo pipefail
          APP_PATH="$(find "${DERIVED_DATA}/Build/Products/Debug-iphonesimulator" -maxdepth 1 -type d -name "*.app" | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "App bundle not found in Debug-iphonesimulator."
            exit 1
          fi

          xcrun simctl install "${SIMULATOR_UDID}" "$APP_PATH"

      - name: Build Unsigned iPhoneOS App
        run: |
          xcodebuild \
            -scheme mZUTiOSApp \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -sdk iphoneos \
            -derivedDataPath "${DERIVED_DATA}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build

      - name: Package Install Artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/install

          SIM_APP_PATH="$(find "${DERIVED_DATA}/Build/Products/Debug-iphonesimulator" -maxdepth 1 -type d -name "*.app" | head -n 1)"
          if [ -n "$SIM_APP_PATH" ]; then
            ditto -c -k --sequesterRsrc --keepParent "$SIM_APP_PATH" "artifacts/install/mzutv2-simulator-app.zip"
          fi

          DEV_APP_PATH="$(find "${DERIVED_DATA}/Build/Products/Release-iphoneos" -maxdepth 1 -type d -name "*.app" | head -n 1)"
          if [ -n "$DEV_APP_PATH" ]; then
            rm -rf Payload
            mkdir -p Payload
            cp -R "$DEV_APP_PATH" "Payload/mzutv2.app"
            /usr/bin/zip -qry "artifacts/install/mzutv2-iphoneos-unsigned.ipa" Payload
            rm -rf Payload
          fi

          cat > artifacts/install/README_INSTALL.txt << 'EOF'
          mzutv2-iphoneos-unsigned.ipa requires Apple code signing before installation on a physical iPhone.
          mzutv2-simulator-app.zip is a simulator package.
          EOF

      - name: Capture Screenshots and Walkthrough
        run: |
          SIMULATOR_UDID="${SIMULATOR_UDID}" \
          APP_BUNDLE_ID="${APP_BUNDLE_ID}" \
          MZUT_LOGIN="${MZUT_LOGIN}" \
          MZUT_PASSWORD="${MZUT_PASSWORD}" \
          OUTPUT_DIR="artifacts" \
          bash scripts/ios_capture_artifacts.sh
        env:
          MZUT_LOGIN: ${{ secrets.MZUT_LOGIN }}
          MZUT_PASSWORD: ${{ secrets.MZUT_PASSWORD }}

      - name: Upload Visual Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-visual-artifacts
          path: artifacts

